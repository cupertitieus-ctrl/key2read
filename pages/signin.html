<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In — key2read</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/auth.css">
</head>
<body>

<div class="auth-page">
  <!-- ===== LEFT PANEL ===== -->
  <div class="auth-left" style="display:flex;align-items:center;justify-content:center;padding:0;overflow:hidden;background:var(--g50,#f9fafb)">
    <a href="/index.html" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center">
      <img src="/public/signin-hero.jpg" alt="key2read" style="width:100%;height:100%;object-fit:contain">
    </a>
  </div>

  <!-- ===== RIGHT PANEL (Form) ===== -->
  <div class="auth-right">
    <div class="auth-form-container">
      <h1 style="text-align:center"><a href="/index.html"><img src="/public/logo.png" alt="key2read" style="height:64px;width:auto;display:inline-block"></a></h1>
      <p style="text-align:center">Select your role and enter your credentials.</p>

      <!-- Role Selector -->
      <div class="role-selector" id="role-selector" style="grid-template-columns:1fr 1fr 1fr 1fr">
        <div class="role-card active" onclick="selectRole(this, 'teacher')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <span>Teacher</span>
        </div>
        <div class="role-card" onclick="selectRole(this, 'parent')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 20a2 2 0 0 1 2-2h3.172a2 2 0 0 1 1.414.586l.828.828a2 2 0 0 0 1.414.586h.344a2 2 0 0 0 1.414-.586l.828-.828A2 2 0 0 1 15.828 18H19a2 2 0 0 1 2 2v1H3v-1z"/><circle cx="8" cy="10" r="3"/><circle cx="16" cy="10" r="3"/></svg>
          <span>Parent</span>
        </div>
        <div class="role-card" onclick="selectRole(this, 'student')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
          <span>Student</span>
        </div>
        <div class="role-card" onclick="selectRole(this, 'child')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span>Child</span>
        </div>
        <div class="role-card" id="owner-role-card" onclick="selectRole(this, 'owner')" style="display:none">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          <span>Owner</span>
        </div>
      </div>

      <!-- Sign In Form -->
      <form class="auth-form" action="dashboard.html">
        <!-- Email (Teacher & Parent & Owner) -->
        <div class="form-group" id="field-email">
          <label class="form-label" for="email">Email Address</label>
          <input type="email" id="email" name="email" class="form-input" placeholder="you@school.edu" autocomplete="email">
        </div>

        <!-- Student/Child Name -->
        <div class="form-group" id="field-name" style="display:none">
          <label class="form-label" for="student-name">Your Name</label>
          <input type="text" id="student-name" name="student-name" class="form-input" placeholder="Enter your first and last name" autocomplete="off">
        </div>

        <!-- Class Code (Student) -->
        <div class="form-group" id="field-classcode" style="display:none">
          <label class="form-label" for="classcode" id="classcode-label">Class Code</label>
          <input type="text" id="classcode" name="classcode" class="form-input" placeholder="Enter your class code" autocomplete="off">
          <small id="classcode-hint" style="color:var(--g400);margin-top:4px;display:block">Ask your teacher for the class code.</small>
        </div>

        <!-- Parent Family Code (not shown — parent logs in with email + password) -->
        <div class="form-group" id="field-parent-code" style="display:none">
          <label class="form-label" for="parent-code">Family Code</label>
          <input type="text" id="parent-code" name="familycode" class="form-input" placeholder="Enter your family code" autocomplete="off">
          <small style="color:var(--g400);margin-top:4px;display:block">Your family code was created when you signed up.</small>
        </div>

        <div class="form-group" id="field-password" style="display:none">
          <label class="form-label" for="password">Password</label>
          <input type="password" id="password" name="password" class="form-input" placeholder="Enter your password" autocomplete="current-password">
        </div>
        <div class="auth-extras" id="field-extras" style="display:none">
          <label class="auth-remember">
            <input type="checkbox" id="remember-me" checked> Remember me
          </label>
          <a href="#" class="auth-forgot">Forgot password?</a>
        </div>
        <button type="submit" class="btn btn-primary btn-lg w-full">Sign In</button>
      </form>

      <div class="auth-divider">
        <span>or continue with</span>
      </div>

      <!-- Social Auth -->
      <div class="auth-social">
        <button type="button" class="btn-social" id="google-btn" onclick="handleGoogleLogin()">
          <svg viewBox="0 0 24 24" width="20" height="20"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          Continue with Google
        </button>
        <button type="button" class="btn-social" id="clever-btn" onclick="handleCleverLogin()">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
          Continue with Clever
        </button>
      </div>


      <div id="auth-error" style="display:none;color:#EF4444;text-align:center;margin-top:12px;font-size:0.875rem"></div>

      <div class="auth-footer">
        Don't have an account? <a href="/index.html#pricing">Subscribe</a>
      </div>

      <div class="auth-back-link" style="display:flex;justify-content:space-between;align-items:center">
        <a href="/index.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          Back to key2read.com
        </a>
        <a href="#" id="admin-login-link" onclick="showAdminLogin(); return false;" style="font-size:0.75rem;color:var(--g400)">Admin login</a>
      </div>
    </div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="/js/api.js"></script>
<script>
let selectedRole = 'teacher';
let googleClientId = null;

function selectRole(el, role) {
  document.querySelectorAll('.role-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  selectedRole = role || el.querySelector('span').textContent.toLowerCase();

  // Toggle fields based on role
  const emailGroup = document.getElementById('field-email');
  const nameGroup = document.getElementById('field-name');
  const codeGroup = document.getElementById('field-classcode');
  const parentCodeGroup = document.getElementById('field-parent-code');
  const passwordGroup = document.getElementById('field-password');
  const extrasGroup = document.getElementById('field-extras');

  // Hide all role-specific fields first
  if (emailGroup) emailGroup.style.display = 'none';
  if (nameGroup) nameGroup.style.display = 'none';
  if (codeGroup) codeGroup.style.display = 'none';
  if (parentCodeGroup) parentCodeGroup.style.display = 'none';
  if (passwordGroup) passwordGroup.style.display = 'none';
  if (extrasGroup) extrasGroup.style.display = 'none';

  if (selectedRole === 'student') {
    // School student: Name + Class Code (required)
    if (nameGroup) nameGroup.style.display = '';
    if (codeGroup) {
      codeGroup.style.display = '';
      document.getElementById('classcode-label').textContent = 'Class Code';
      document.getElementById('classcode').placeholder = 'Enter your class code';
      document.getElementById('classcode-hint').textContent = 'Ask your teacher for the class code.';
    }
  } else if (selectedRole === 'child') {
    // Homeschool child: Name + Family Code
    if (nameGroup) nameGroup.style.display = '';
    if (codeGroup) {
      codeGroup.style.display = '';
      document.getElementById('classcode-label').textContent = 'Family Code';
      document.getElementById('classcode').placeholder = 'Enter your family code';
      document.getElementById('classcode-hint').textContent = 'Ask your parent for the family code.';
    }
  } else if (selectedRole === 'parent') {
    if (emailGroup) emailGroup.style.display = '';
    if (passwordGroup) passwordGroup.style.display = '';
    if (extrasGroup) extrasGroup.style.display = '';
  } else if (selectedRole === 'owner') {
    if (emailGroup) emailGroup.style.display = '';
    if (passwordGroup) passwordGroup.style.display = '';
  } else {
    // Teacher: email + password login
    if (emailGroup) emailGroup.style.display = '';
    if (passwordGroup) passwordGroup.style.display = '';
    if (extrasGroup) extrasGroup.style.display = '';
  }
}

function showAdminLogin() {
  const ownerCard = document.getElementById('owner-role-card');
  const selector = document.getElementById('role-selector');
  if (ownerCard) {
    ownerCard.style.display = '';
    selector.style.gridTemplateColumns = '1fr 1fr 1fr 1fr';
  }
  // Hide the admin link
  const adminLink = document.getElementById('admin-login-link');
  if (adminLink) adminLink.style.display = 'none';
}

function showError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 5000);
}

// Check status on load
(async function() {
  try {
    const status = await API.getStatus();
    if (status.googleConfigured) {
      googleClientId = true;
      // Initialize Google Identity Services
      google.accounts.id.initialize({
        client_id: status.googleClientId,
        callback: handleGoogleCredential,
        auto_select: false
      });
    }
  } catch(e) { /* Server may not be running, demo mode still works */ }
})();

// Initialize fields for default role (Teacher) on page load
selectRole(document.querySelector('.role-card.active'), 'teacher');

// Auto-fill and auto-login from localStorage if previously remembered
(async function() {
  // Auto-signin for remembered teacher/parent (email + password)
  const savedCreds = localStorage.getItem('k2r_remember_creds');
  if (savedCreds) {
    try {
      const creds = JSON.parse(atob(savedCreds));
      if (creds.email && creds.password && creds.role) {
        // Show loading state
        const submitBtn = document.querySelector('.auth-form button[type="submit"]');
        if (submitBtn) { submitBtn.textContent = 'Signing in...'; submitBtn.disabled = true; }
        await API.login({ email: creds.email, password: creds.password, role: creds.role, rememberMe: true });
        window.location.href = 'dashboard.html';
        return;
      }
    } catch(e) {
      // Only clear saved creds on auth failures, not network/server errors
      const msg = (e.message || '').toLowerCase();
      if (msg.includes('password') || msg.includes('not found') || msg.includes('no account')) {
        localStorage.removeItem('k2r_remember_creds');
      }
      const submitBtn = document.querySelector('.auth-form button[type="submit"]');
      if (submitBtn) { submitBtn.textContent = 'Sign In'; submitBtn.disabled = false; }
    }
  }

  // Fallback: auto-fill email only (if saved from older version)
  const savedEmail = localStorage.getItem('k2r_remember_email');
  if (savedEmail) {
    const emailInput = document.getElementById('email');
    if (emailInput) emailInput.value = savedEmail;
  }

  // Auto-signin for students (localStorage)
  const savedName = localStorage.getItem('k2r_student_name');
  const savedCode = localStorage.getItem('k2r_student_classcode');
  if (savedName && savedCode) {
    try {
      await API.login({ name: savedName, classCode: savedCode, role: 'student' });
      window.location.href = 'dashboard.html';
    } catch(e) {
      localStorage.removeItem('k2r_student_name');
      localStorage.removeItem('k2r_student_classcode');
    }
    return;
  }
  // Auto-signin for homeschool children
  const savedChildName = localStorage.getItem('k2r_child_name');
  const savedFamilyCode = localStorage.getItem('k2r_child_familycode');
  if (savedChildName && savedFamilyCode) {
    try {
      await API.login({ name: savedChildName, classCode: savedFamilyCode, role: 'child' });
      window.location.href = 'dashboard.html';
    } catch(e) {
      localStorage.removeItem('k2r_child_name');
      localStorage.removeItem('k2r_child_familycode');
    }
  }
})();

// Form submit
document.querySelector('.auth-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  if (selectedRole === 'student') {
    const name = document.getElementById('student-name').value.trim();
    const classCode = document.getElementById('classcode').value.trim();
    if (!name) return showError('Please enter your name');
    if (!classCode) return showError('Please enter your class code');
    try {
      await API.login({ name, classCode, role: 'student' });
      // Save to localStorage for auto-signin next time
      localStorage.setItem('k2r_student_name', name);
      localStorage.setItem('k2r_student_classcode', classCode);
      window.location.href = 'dashboard.html';
    } catch(e) { showError(e.message || 'Login failed. Check your name and class code.'); }
  } else if (selectedRole === 'child') {
    const name = document.getElementById('student-name').value.trim();
    const familyCode = document.getElementById('classcode').value.trim();
    if (!name) return showError('Please enter your name');
    if (!familyCode) return showError('Please enter your family code');
    try {
      await API.login({ name, classCode: familyCode, role: 'child' });
      localStorage.setItem('k2r_child_name', name);
      localStorage.setItem('k2r_child_familycode', familyCode);
      window.location.href = 'dashboard.html';
    } catch(e) { showError(e.message || 'Login failed. Check your name and family code.'); }
  } else if (selectedRole === 'parent') {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('remember-me')?.checked || false;
    if (!email) return showError('Please enter your email');
    if (!password) return showError('Please enter your password');
    try {
      await API.login({ email, password, role: 'parent', rememberMe });
      if (rememberMe) {
        localStorage.setItem('k2r_remember_creds', btoa(JSON.stringify({ email, password, role: 'parent' })));
        localStorage.setItem('k2r_remember_email', email);
      } else {
        localStorage.removeItem('k2r_remember_creds');
        localStorage.removeItem('k2r_remember_email');
      }
      window.location.href = 'dashboard.html';
    } catch(e) { showError(e.message || 'Login failed. Check your email and password.'); }
  } else if (selectedRole === 'owner') {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email) return showError('Please enter your email');
    if (!password) return showError('Please enter your password');
    try {
      await API.login({ email, password, role: 'owner' });
      window.location.href = 'dashboard.html';
    } catch(e) { showError(e.message || 'Login failed. Check your credentials.'); }
  } else {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('remember-me')?.checked || false;
    if (!email) return showError('Please enter your email');
    if (!password) return showError('Please enter your password');
    try {
      await API.login({ email, password, role: selectedRole, rememberMe });
      if (rememberMe) {
        localStorage.setItem('k2r_remember_creds', btoa(JSON.stringify({ email, password, role: selectedRole })));
        localStorage.setItem('k2r_remember_email', email);
      } else {
        localStorage.removeItem('k2r_remember_creds');
        localStorage.removeItem('k2r_remember_email');
      }
      window.location.href = 'dashboard.html';
    } catch(e) { showError(e.message || 'Login failed. Check your email and password.'); }
  }
});

async function handleGoogleLogin() {
  if (googleClientId) {
    google.accounts.id.prompt();
  } else {
    // No Google client ID configured — use demo mode with Google-like UX
    try {
      await API.demoLogin('Sarah Johnson (Google)', 'sarah@demo.com');
      window.location.href = 'dashboard.html';
    } catch(e) { showError('Login failed'); }
  }
}

async function handleGoogleCredential(response) {
  try {
    await API.googleLogin(response.credential);
    window.location.href = 'dashboard.html';
  } catch(e) { showError('Google sign-in failed'); }
}

async function handleCleverLogin() {
  try {
    // If Clever is configured, redirect to Clever OAuth
    const status = await API.getStatus();
    if (status.cleverConfigured) {
      window.location.href = `https://clever.com/oauth/authorize?response_type=code&client_id=${status.cleverClientId}&redirect_uri=${encodeURIComponent(window.location.origin + '/api/auth/clever/callback')}`;
    } else {
      // Demo mode
      await API.cleverLogin('demo');
      window.location.href = 'dashboard.html';
    }
  } catch(e) { showError('Clever login failed'); }
}

async function handleDemoLogin() {
  try {
    const demoRole = selectedRole || 'teacher';
    const demoName = demoRole === 'student' ? 'Demo Student' : demoRole === 'parent' ? 'Demo Parent' : 'Sarah Johnson';
    const demoEmail = demoRole === 'student' ? 'demo-student@demo.com' : demoRole === 'parent' ? 'demo-parent@demo.com' : 'sarah@demo.com';
    await API.demoLogin(demoName, demoEmail, demoRole);
    window.location.href = 'dashboard.html';
  } catch(e) { showError('Demo login failed. Is the server running?'); }
}
</script>

</body>
</html>
