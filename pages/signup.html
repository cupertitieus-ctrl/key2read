<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up â€” key2read</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/auth.css">
</head>
<body>

<div class="auth-page">
  <!-- ===== LEFT PANEL ===== -->
  <div class="auth-left">
    <a href="/index.html" class="auth-left-logo">
      <img src="/public/logo.png" alt="key2read" style="height:48px;width:auto">
    </a>
    <div class="auth-left-content">
      <h2>Start reading today!</h2>
      <p>Free to set up. No credit card needed.</p>

      <div class="auth-left-features">
        <div class="auth-left-feature">
          <span class="auth-left-feature-icon">ðŸ“š</span>
          <span>Quizzes for popular chapter books</span>
        </div>
        <div class="auth-left-feature">
          <span class="auth-left-feature-icon">ðŸ”‘</span>
          <span>Earn keys and shop in the Class Store</span>
        </div>
        <div class="auth-left-feature">
          <span class="auth-left-feature-icon">ðŸ§ </span>
          <span>Build real reading comprehension skills</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== RIGHT PANEL (Form) ===== -->
  <div class="auth-right">
    <div class="auth-form-container">
      <h1>Create your account</h1>
      <p>Get started with key2read for free. No credit card required.</p>

      <!-- Role Selector -->
      <div class="role-selector" style="grid-template-columns: 1fr 1fr 1fr">
        <div class="role-card active" data-role="teacher" onclick="selectRole(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <span>Teacher</span>
        </div>
        <div class="role-card" data-role="parent" onclick="selectRole(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 20a2 2 0 0 1 2-2h3.172a2 2 0 0 1 1.414.586l.828.828a2 2 0 0 0 1.414.586h.344a2 2 0 0 0 1.414-.586l.828-.828A2 2 0 0 1 15.828 18H19a2 2 0 0 1 2 2v1H3v-1z"/><circle cx="8" cy="10" r="3"/><circle cx="16" cy="10" r="3"/>
          </svg>
          <span>Parent</span>
        </div>
        <div class="role-card" data-role="student" onclick="selectRole(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
          </svg>
          <span>Student</span>
        </div>
      </div>

      <!-- Sign Up Form -->
      <form class="auth-form" id="signup-form">
        <!-- Name row (always visible) -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="first-name">First Name</label>
            <input type="text" id="first-name" class="form-input" placeholder="Sarah" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="last-name">Last Name</label>
            <input type="text" id="last-name" class="form-input" placeholder="Johnson" required>
          </div>
        </div>

        <!-- Email (Teacher & Principal) -->
        <div class="form-group" id="field-email">
          <label class="form-label" for="email">School Email</label>
          <input type="email" id="email" class="form-input" placeholder="you@school.edu">
        </div>

        <!-- School Name (Teacher) -->
        <div class="form-group" id="field-school">
          <label class="form-label" for="school">School Name</label>
          <input type="text" id="school" class="form-input" placeholder="Lincoln Elementary School">
        </div>

        <!-- Grade Level (Teacher) -->
        <div class="form-group" id="field-grade">
          <label class="form-label" for="grade">Grade Level You Teach</label>
          <select id="grade" class="form-input" style="appearance:auto">
            <option value="">Select grade...</option>
            <option value="K">Kindergarten</option>
            <option value="1st">1st Grade</option>
            <option value="2nd">2nd Grade</option>
            <option value="3rd">3rd Grade</option>
            <option value="4th">4th Grade</option>
            <option value="5th">5th Grade</option>
            <option value="6th">6th Grade</option>
            <option value="7th">7th Grade</option>
            <option value="8th">8th Grade</option>
            <option value="9th">9th Grade</option>
            <option value="10th">10th Grade</option>
            <option value="11th">11th Grade</option>
            <option value="12th">12th Grade</option>
          </select>
        </div>

        <!-- School/District Name (Principal) -->
        <div class="form-group" id="field-district" style="display:none">
          <label class="form-label" for="district">School / District Name</label>
          <input type="text" id="district" class="form-input" placeholder="Lincoln Unified School District">
        </div>

        <!-- Class Code (Student) -->
        <div class="form-group" id="field-classcode" style="display:none">
          <label class="form-label" for="classcode">Class Code</label>
          <input type="text" id="classcode" class="form-input" placeholder="Enter your teacher's class code">
          <small style="color:var(--g400);margin-top:4px;display:block">Ask your teacher for the class code to join their class.</small>
        </div>

        <!-- Password (always visible) -->
        <div class="form-group" id="field-password">
          <label class="form-label" for="password">Password</label>
          <input type="password" id="password" class="form-input" placeholder="Create a strong password">
          <small id="password-optional" style="color:var(--g400);margin-top:4px;display:none">Password is optional for students.</small>
        </div>

        <!-- Terms (Teacher & Principal) -->
        <label class="auth-terms" id="field-terms">
          <input type="checkbox" id="terms-checkbox">
          I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>
        </label>

        <button type="submit" class="btn btn-primary btn-lg w-full">Create Account</button>
      </form>

      <div class="auth-divider">
        <span>or continue with</span>
      </div>

      <!-- Social Auth -->
      <div class="auth-social">
        <button type="button" class="btn-social" onclick="handleGoogleLogin()">
          <svg viewBox="0 0 24 24" width="20" height="20"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          Continue with Google
        </button>
        <button type="button" class="btn-social" onclick="handleCleverLogin()">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
          Continue with Clever
        </button>
      </div>

      <div id="auth-error" style="display:none;color:#EF4444;text-align:center;margin-top:12px;font-size:0.875rem"></div>

      <div class="auth-footer">
        Already have an account? <a href="signin.html">Sign in</a>
      </div>

      <div class="auth-back-link">
        <a href="/index.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          Back to key2read.com
        </a>
      </div>
    </div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="/js/api.js"></script>
<script>
// --- Helpers ---
function showError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 5000);
}

function getSelectedRole() {
  const active = document.querySelector('.role-card.active');
  return active ? active.dataset.role : 'teacher';
}

// --- Role Selector ---
function selectRole(el) {
  // Remove active from all cards
  document.querySelectorAll('.role-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');

  const role = el.dataset.role;

  // Field references
  const fieldEmail     = document.getElementById('field-email');
  const fieldSchool    = document.getElementById('field-school');
  const fieldGrade     = document.getElementById('field-grade');
  const fieldDistrict  = document.getElementById('field-district');
  const fieldClasscode = document.getElementById('field-classcode');
  const fieldTerms     = document.getElementById('field-terms');
  const passwordHint   = document.getElementById('password-optional');

  // Hide all role-specific fields first
  fieldEmail.style.display     = 'none';
  fieldSchool.style.display    = 'none';
  fieldGrade.style.display     = 'none';
  fieldDistrict.style.display  = 'none';
  fieldClasscode.style.display = 'none';
  fieldTerms.style.display     = 'none';
  passwordHint.style.display   = 'none';

  // Show fields based on role
  const fieldPassword = document.getElementById('field-password');
  if (role === 'teacher') {
    fieldEmail.style.display  = '';
    fieldSchool.style.display = '';
    fieldGrade.style.display  = '';
    fieldTerms.style.display  = '';
    fieldPassword.style.display = '';
  } else if (role === 'parent') {
    fieldEmail.style.display    = '';
    fieldTerms.style.display    = '';
    fieldPassword.style.display = '';
  } else if (role === 'student') {
    fieldClasscode.style.display = '';
    fieldPassword.style.display  = 'none';
  }
}

// --- Form Submit ---
document.getElementById('signup-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const role      = getSelectedRole();
  const firstName = document.getElementById('first-name').value.trim();
  const lastName  = document.getElementById('last-name').value.trim();
  const password  = document.getElementById('password').value;
  const name      = firstName + ' ' + lastName;

  if (!firstName || !lastName) {
    return showError('Please enter your first and last name.');
  }

  if (role === 'teacher') {
    const email  = document.getElementById('email').value.trim();
    const school = document.getElementById('school').value.trim();
    const grade  = document.getElementById('grade').value;
    const terms  = document.getElementById('terms-checkbox').checked;
    if (!email)    return showError('Please enter your school email.');
    if (!school)   return showError('Please enter your school name.');
    if (!grade)    return showError('Please select your grade level.');
    if (!password) return showError('Please create a password.');
    if (!terms)    return showError('Please agree to the Terms of Service and Privacy Policy.');

    try {
      await API.post('/api/auth/signup', { name, email, password, role: 'teacher', school, grade });
      window.location.href = 'dashboard.html';
    } catch (err) {
      showError(err.message || 'Signup failed. Please try again.');
    }

  } else if (role === 'parent') {
    const email = document.getElementById('email').value.trim();
    const terms = document.getElementById('terms-checkbox').checked;
    if (!email)    return showError('Please enter your email.');
    if (!password) return showError('Please create a password.');
    if (!terms)    return showError('Please agree to the Terms of Service and Privacy Policy.');

    try {
      await API.post('/api/auth/signup', { name, email, password, role: 'parent' });
      window.location.href = 'dashboard.html';
    } catch (err) {
      showError(err.message || 'Signup failed. Please try again.');
    }

  } else if (role === 'student') {
    const classCode = document.getElementById('classcode').value.trim();
    if (!classCode) return showError('Please enter your class code.');

    try {
      await API.post('/api/auth/signup', { name, password: password || null, role: 'student', classCode });
      // Save to localStorage for auto-signin next time
      localStorage.setItem('k2r_student_name', name);
      localStorage.setItem('k2r_student_classcode', classCode);
      window.location.href = 'dashboard.html';
    } catch (err) {
      showError(err.message || 'Signup failed. Please try again.');
    }
  }
});

// --- Social / Demo Auth ---
async function handleGoogleLogin() {
  try {
    await API.demoLogin('Sarah Johnson (Google)', 'sarah@demo.com');
    window.location.href = 'dashboard.html';
  } catch (e) {
    showError('Google sign-in failed');
  }
}

async function handleCleverLogin() {
  try {
    await API.cleverLogin('demo');
    window.location.href = 'dashboard.html';
  } catch (e) {
    showError('Clever login failed');
  }
}

async function handleDemoLogin() {
  try {
    const role = getSelectedRole();
    const demoName = role === 'student' ? 'Demo Student' : role === 'principal' ? 'Demo Principal' : 'Sarah Johnson';
    const demoEmail = role === 'student' ? 'demo-student@demo.com' : role === 'principal' ? 'demo-principal@demo.com' : 'sarah@demo.com';
    await API.demoLogin(demoName, demoEmail, role);
    window.location.href = 'dashboard.html';
  } catch (e) {
    showError('Demo login failed. Is the server running?');
  }
}
</script>
</body>
</html>
